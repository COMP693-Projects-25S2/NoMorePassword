{% extends 'userbase.html' %}

{% block title %}Travel Journal{% endblock %}

{# Set the active page to be highlighted in the navigation bar. #}
{% set active_page = 'login' %}

{% block content %}
<!-- Banner image with text overlay -->
<div class="banner-image"
    style="background-image: url('/static/ui_photos/private_journey.jpg'); background-size: cover; background-position: center; height: 300px; position: relative;">
    <div class="banner-overlay"
        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-md-12 text-end">
                    <h1 class="text-white fw-bold">Login</h1>
                    <p class="text-white lead">Log in to share your journey.</p>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h3 class="card-title mb-0">Login</h3>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <form method="POST"
                        action="{{ url_for('login') }}{% if nmp_injected %}?nmp_injected=true&nmp_user_id={{ nmp_user_id }}&nmp_username={{ nmp_username }}&nmp_client_type={{ nmp_client_type }}&nmp_timestamp={{ nmp_timestamp }}{% endif %}">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username"
                                value="{{ username if username }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-dark">Login</button>
                        </div>
                    </form>

                    <!-- No More Password Binding Section (only shown when accessed via C-Client) -->
                    {% if nmp_injected %}
                    <div id="nmp-binding-section" class="mt-4">
                        <hr>
                        <div class="text-center">
                            <h5 class="text-primary">ğŸ” No More Password</h5>

                            <!-- Auto Refresh Option -->
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="nmp-auto-refresh" checked>
                                <label class="form-check-label" for="nmp-auto-refresh">
                                    <small>Enable auto-refresh for seamless login</small>
                                </label>
                            </div>

                            <!-- Two NMP options -->
                            <div class="d-grid gap-2">
                                <!-- For re-binding previously registered users -->
                                <button id="nmp-bind-btn" class="btn btn-outline-dark btn-sm"
                                    style="border-color: #000000; color: #000000; transition: all 0.3s ease;"
                                    onmouseover="this.style.backgroundColor='#000000'; this.style.color='#ffffff';"
                                    onmouseout="this.style.backgroundColor='transparent'; this.style.color='#000000';">
                                    <i class="fas fa-key"></i> Login with No More Password
                                </button>

                                <!-- For new users -->
                                <button id="nmp-signup-btn" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-user-plus"></i> Sign Up with No More Password
                                </button>
                            </div>

                            <div id="nmp-status" class="mt-2"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer text-center">
                    <p class="mb-0">Don't have an account? <a href="{{ url_for('signup') }}">Sign up here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- No More Password Integration Script -->
{% if nmp_injected %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸ” No More Password integration detected via server-side detection');

        // Get elements
        const bindBtn = document.getElementById('nmp-bind-btn');
        const signupBtn = document.getElementById('nmp-signup-btn');
        const statusDiv = document.getElementById('nmp-status');
        const autoRefreshCheckbox = document.getElementById('nmp-auto-refresh');

        // Helper function to show loading state
        function showLoading(button, text) {
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}...`;
        }

        // Helper function to reset button
        function resetButton(button, originalText, originalClass) {
            button.disabled = false;
            button.innerHTML = originalText;
            button.className = originalClass;
        }

        // Helper function to show success
        function showSuccess(button, text, successClass) {
            button.innerHTML = `<i class="fas fa-check"></i> ${text}`;
            button.className = successClass;
        }


        // Bind with existing credentials
        if (bindBtn) {
            bindBtn.addEventListener('click', async function () {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const autoRefresh = autoRefreshCheckbox.checked;

                console.log(`ğŸ” Login with NMP - Username: ${username ? 'provided' : 'empty'}, Password: ${password ? 'provided' : 'empty'}`);

                try {
                    showLoading(bindBtn, 'Logging in');

                    if (username && password) {
                        // ç”¨æˆ·è¾“å…¥äº†è´¦å·å¯†ç ï¼Œé€šè¿‡è¡¨å•æäº¤å¤„ç†ï¼ˆè¿™ä¼šè§¦å‘NSNçš„NMPè½¬å‘é€»è¾‘ï¼‰
                        console.log('ğŸ” User provided credentials, submitting form for NMP processing');
                        statusDiv.innerHTML = '<div class="alert alert-info">Processing login with provided credentials...</div>';

                        // åˆ›å»ºéšè—çš„è¡¨å•å¹¶æäº¤ï¼ŒåŒ…å«NMPå‚æ•°
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '{{ url_for("login") }}?nmp_injected=true&nmp_user_id={{ nmp_user_id }}&nmp_username={{ nmp_username }}&nmp_client_type={{ nmp_client_type }}&nmp_timestamp={{ nmp_timestamp }}';

                        // æ·»åŠ ç”¨æˆ·åå’Œå¯†ç å­—æ®µ
                        const usernameField = document.createElement('input');
                        usernameField.type = 'hidden';
                        usernameField.name = 'username';
                        usernameField.value = username;
                        form.appendChild(usernameField);

                        const passwordField = document.createElement('input');
                        passwordField.type = 'hidden';
                        passwordField.name = 'password';
                        passwordField.value = password;
                        form.appendChild(passwordField);

                        document.body.appendChild(form);
                        form.submit();
                        return;
                    } else {
                        // ç”¨æˆ·æ²¡æœ‰è¾“å…¥è´¦å·å¯†ç ï¼Œç›´æ¥è°ƒç”¨B-clientçš„Login with NMP
                        console.log('ğŸ” No credentials provided, trying Login with NMP directly');
                        statusDiv.innerHTML = '<div class="alert alert-info">Logging in with No More Password...</div>';

                        // ç›´æ¥è°ƒç”¨B-client APIï¼Œä¸æä¾›è´¦å·å¯†ç 
                        let response = await fetch('http://localhost:3000/bind', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                request_type: 1,
                                user_id: '{{ nmp_user_id }}',
                                user_name: '{{ nmp_username }}',
                                domain_id: 'localhost:5000',
                                node_id: 'nsn-node-001',
                                auto_refresh: autoRefresh,
                                login_source: 'direct' // ç›´æ¥è°ƒç”¨ï¼Œéè¡¨å•æ¥æº
                            })
                        });

                        console.log('ğŸ” Login with NMP response status:', response.status);

                        // å¤„ç†å“åº”ï¼Œå³ä½¿æ˜¯400çŠ¶æ€ç ä¹Ÿè¦å°è¯•è§£æJSON
                        const responseText = await response.text();
                        console.log('ğŸ” Login with NMP raw response:', responseText);

                        let result;
                        try {
                            result = JSON.parse(responseText);
                            console.log('ğŸ” Login with NMP result:', result);
                        } catch (parseError) {
                            console.error('âŒ Failed to parse Login with NMP response as JSON:', parseError);
                            throw new Error('Invalid response format from B-Client');
                        }

                        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                        if (!response.ok && result.error) {
                            throw new Error(result.error);
                        }
                    }

                    // å¤„ç†å“åº”ç»“æœï¼ˆåªæœ‰ç›´æ¥è°ƒç”¨B-clientæ—¶æ‰ä¼šåˆ°è¾¾è¿™é‡Œï¼‰
                    if (typeof result !== 'undefined' && result && result.success) {
                        console.log('ğŸ” Login with NMP successful:', result);

                        statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Successfully logged in with No More Password!</div>';
                        showSuccess(bindBtn, 'Login Successful', 'btn btn-success btn-sm');
                        signupBtn.style.display = 'none';

                        // æ£€æŸ¥æ˜¯å¦æœ‰sessionæ•°æ®ç”¨äºè‡ªåŠ¨ç™»å½•
                        if (result.login_success && result.complete_session_data) {
                            console.log('ğŸ” Login with NMP successful, C-Client will handle auto-login...');
                            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Login successful! C-Client will handle auto-login...</div>';
                        } else {
                            console.log('âœ… Login with NMP successful, but no auto-login session data provided');
                            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Successfully logged in! You can now use No More Password features.</div>';
                        }
                    } else {
                        // Handle error cases from B-Client
                        const errorMessage = (typeof result !== 'undefined' && result && result.error) || 'Login with NMP failed';

                        // Reset button state for all error cases
                        resetButton(bindBtn, '<i class="fas fa-key"></i> Login with No More Password', 'btn btn-outline-dark btn-sm');

                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå¼•å¯¼ç”¨æˆ·å°è¯•å…¶ä»–é€‰é¡¹
                        if (errorMessage.includes('Wrong account or password')) {
                            statusDiv.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ${errorMessage}</div>`;
                        } else if (errorMessage.includes('No existing')) {
                            statusDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-info-circle"></i> ${errorMessage}. Please try signing up with NMP instead.</div>`;
                        } else {
                            statusDiv.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ${errorMessage}</div>`;
                        }
                    }
                } catch (error) {
                    console.error('âŒ NMP Bind Error:', error);
                    statusDiv.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Bind failed: ${error.message}</div>`;
                    resetButton(bindBtn, '<i class="fas fa-key"></i> Login with No More Password', 'btn btn-outline-dark btn-sm');
                }
            });
        }

        // Sign up new user - directly call B-Client API
        if (signupBtn) {
            signupBtn.addEventListener('click', async function () {
                const autoRefresh = autoRefreshCheckbox.checked;

                try {
                    showLoading(signupBtn, 'Checking');
                    statusDiv.innerHTML = '<div class="alert alert-info">Checking if account already exists...</div>';

                    // First check if user already has an account
                    console.log('ğŸ” Checking if user already has an account...');
                    const checkResponse = await fetch('http://localhost:3000/bind', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            request_type: 1,
                            user_id: '{{ nmp_user_id }}',
                            user_name: '{{ nmp_username }}',
                            domain_id: 'localhost:5000',
                            node_id: 'nsn-node-001'
                        })
                    });

                    const checkResult = await checkResponse.json();
                    console.log('ğŸ” Account check result:', checkResult);

                    // If user already has an account, show message and hide signup button
                    if (checkResponse.ok && checkResult.success) {
                        statusDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-info-circle"></i> Account already exists! Please use "Login with No More Password" instead.</div>';
                        showSuccess(signupBtn, 'Account Exists', 'btn btn-warning btn-sm');
                        bindBtn.style.display = 'block';
                        return;
                    }

                    // If no account exists, proceed with registration
                    showLoading(signupBtn, 'Signing up');
                    statusDiv.innerHTML = '<div class="alert alert-info">Creating new account with No More Password...</div>';

                    // Call B-Client API directly for auto registration
                    console.log('ğŸ” Calling B-Client API at http://localhost:3000/bind');
                    console.log('ğŸ” Request data:', {
                        request_type: 0,
                        user_id: '{{ nmp_user_id }}',
                        user_name: '{{ nmp_username }}',
                        domain_id: 'localhost:5000',
                        node_id: 'nsn-node-001',
                        auto_refresh: autoRefresh
                    });

                    const response = await fetch('http://localhost:3000/bind', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            request_type: 0,
                            user_id: '{{ nmp_user_id }}',
                            user_name: '{{ nmp_username }}',
                            domain_id: 'localhost:5000', // Use the correct domain from B-Client config
                            node_id: 'nsn-node-001',
                            auto_refresh: autoRefresh,
                            username: '{{ nmp_username }}', // Use NMP username as NSN username
                            email: '{{ nmp_username }}@nomorepassword.local',
                            first_name: '{{ nmp_username }}'.split('-')[0] || '{{ nmp_username }}',
                            last_name: 'NMP User',
                            location: 'Unknown'
                        })
                    });

                    console.log('ğŸ” B-Client API response status:', response.status);
                    console.log('ğŸ” B-Client API response headers:', response.headers);

                    const responseData = await response.json();
                    console.log('ğŸ” Full B-Client response:', responseData);
                    console.log('ğŸ” Response OK:', response.ok);
                    console.log('ğŸ” Response success:', responseData.success);

                    if (response.ok && responseData.success) {
                        const result = responseData; // B-Client returns data directly
                        console.log('ğŸ” B-Client data:', result);
                        console.log('ğŸ” Registration success:', result.login_success);
                        console.log('ğŸ” Login success:', result.login_success);
                        console.log('ğŸ” Session info:', result);

                        statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Successfully created account and bound to No More Password!</div>';
                        showSuccess(signupBtn, 'Signup Successful', 'btn btn-success btn-sm');
                        bindBtn.style.display = 'none';

                        // B-Client has registered the user successfully
                        // C-Client will handle auto-login via URL injection
                        if (result.login_success) {
                            console.log('ğŸ” B-Client registration successful, C-Client will handle auto-login via URL injection...');
                            console.log('ğŸ” Registration success:', result.login_success);
                            console.log('ğŸ” Login success:', result.login_success);
                            console.log('ğŸ” Session info:', result);

                            // B-Client has registered the user and sent registration info to C-Client
                            // C-Client will handle the auto-login via URL injection, no need for NSN to do anything
                            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Account created! C-Client will handle auto-login...</div>';

                            // C-Client will handle auto-login immediately
                            console.log('ğŸ”„ C-Client will handle auto-login immediately...');

                            // C-Client will handle the auto-login process via URL injection
                            // No need for NSN to perform additional login steps
                        } else {
                            console.log('âŒ B-Client registration failed');
                            console.log('âŒ Registration success:', result.login_success);
                            console.log('âŒ Login success:', result.login_success);
                            console.log('âŒ Session info exists:', !!result);
                            statusDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Registration failed. Please try again.</div>';
                        }
                    } else {
                        throw new Error(responseData.error || 'Signup failed');
                    }
                } catch (error) {
                    console.error('âŒ NMP Signup Error:', error);
                    console.error('âŒ Error details:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    statusDiv.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Signup failed: ${error.message}</div>`;
                    resetButton(signupBtn, '<i class="fas fa-user-plus"></i> Sign Up with No More Password', 'btn btn-outline-success btn-sm');
                }
            });
        }
    });
</script>
{% endif %}

{% endblock %}