{% extends "userbase.html" %} {% block title %}Comment Moderation Dashboard{%
endblock %} {% set active_page = 'comment_moderation' %} {% block content %}
<div
  class="banner-image"
  style="
    background-image: url('/static/ui_photos/private_journey.jpg');
    background-size: cover;
    background-position: center;
    height: 300px;
    position: relative;
  "
>
  <div
    class="banner-overlay"
    style="
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
    "
  >
    <div class="container h-100">
      <div class="row h-100 align-items-center">
        <div class="col-md-12 text-end">
          <h1 class="text-white fw-bold">Comment Moderation Dashboard</h1>
          <p class="text-white lead">Review all the reported comments</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  {% if reported_comments %}
  <div class="card">
    <div class="card-header bg-dark text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-comments me-2"></i>Comment Reports
        </h5>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Reported At</th>
              <th>Event</th>
              <th>Comment Content</th>
              <th>Author</th>
              <th>Reporter</th>
              <th>Report Reason</th>
              <th>Details</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reported_comments %}
            <tr id="report-row-{{ report.report_id }}">
              <td>{{ report.report_created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ report.event_title|truncate(30) }}</td>
              <td
                style="
                  max-width: 200px;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                "
                title="{{ report.comment_content }}"
              >
                {{ report.comment_content|truncate(50) }}
              </td>
              <td>{{ report.comment_author_username }}</td>
              <td>{{ report.reporter_username }}</td>
              <td>{{ report.report_reason.title() }}</td>
              <td
                style="
                  max-width: 150px;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                "
                title="{{ report.report_details }}"
              >
                {{ report.report_details|truncate(30) }}
              </td>
              <td>
                <span
                  class="badge {% if report.report_status == 'pending' %}bg-warning text-dark {% elif report.report_status == 'reviewed' %}bg-success {% elif report.report_status == 'dismissed' %}bg-secondary {% elif report.report_status == 'hidden' %}bg-info {% elif report.report_status == 'escalated' %}bg-danger {% else %}bg-info{% endif %}"
                >
                  {{ report.report_status.title() }}
                </span>
              </td>
              <td>
                <div class="btn-group-vertical d-grid gap-1">
                  {% if report.report_status == 'pending' %}
                  <!-- Initial state: show Hide and Dismiss buttons -->
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    onclick="showHideModal({{ report.report_id }}, {{ report.comment_id }})"
                  >
                    <i class="fas fa-eye-slash me-1"></i>Hide
                  </button>

                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    onclick="takeAction({{ report.report_id }}, 'dismiss')"
                  >
                    <i class="fas fa-times me-1"></i>Dismiss
                  </button>

                  {% elif report.report_status == 'hidden' %}
                  <!-- Hidden state: show Escalate to Admin button -->
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    onclick="takeAction({{ report.report_id }}, 'escalate_to_admin')"
                  >
                    <i class="fas fa-arrow-up me-1"></i>Escalate
                  </button>

                  {% elif report.report_status == 'escalated' and
                  current_user_role == 'admin' %}
                  <!-- Escalated state and admin: show Ban User and Dismiss buttons -->
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    onclick="confirmBanUser({{ report.report_id }}, '{{ report.comment_author_username }}')"
                  >
                    <i class="fas fa-ban me-1"></i>Ban Owner
                  </button>

                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    onclick="takeAction({{ report.report_id }}, 'dismiss')"
                  >
                    <i class="fas fa-times me-1"></i>Dismiss
                  </button>

                  {% elif report.report_status == 'dismissed' or
                  report.report_status == 'reviewed' %} {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info">
    <div class="text-center py-5">
      <i class="fas fa-clipboard-check fa-4x text-muted mb-3"></i>
      <h4>No Comment Reports</h4>
      <p class="mb-0">No pending reports at the moment.</p>
      <p class="text-muted">
        New reports will appear here when users submit them.
      </p>
    </div>
  </div>
  {% endif %}
</div>

<!--Confirmation of Ban User -->
<div
  class="modal fade"
  id="banUserModal"
  tabindex="-1"
  aria-labelledby="banUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="banUserModalLabel">Confirm User Ban</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to ban user <span id="banUsername"></span>?</p>
        <p class="text-danger">This action cannot be undone.</p>
        <input type="hidden" id="banReportId" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" onclick="banUser()">
          Confirm Ban
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hide Comment Modal -->
<div
  class="modal fade"
  id="hideCommentModal"
  tabindex="-1"
  aria-labelledby="hideCommentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hideCommentModalLabel">Hide Comment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="hideCommentForm">
          <input type="hidden" id="hideReportId" name="report_id" />
          <input type="hidden" id="hideCommentId" name="comment_id" />
          <div class="mb-3">
            <label for="moderationReason" class="form-label"
              >Reason for Hiding (will be shown to author if applicable):</label
            >
            <textarea
              class="form-control"
              id="moderationReason"
              name="moderation_reason"
              rows="3"
              required
            ></textarea>
          </div>
          <button type="submit" class="btn btn-danger">Confirm Hide</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  // diplay the Hide Comment modal
  function showHideModal(reportId, commentId) {
    document.getElementById("hideReportId").value = reportId;
    document.getElementById("hideCommentId").value = commentId;
    var hideModal = new bootstrap.Modal(
      document.getElementById("hideCommentModal")
    );
    hideModal.show();
  }

  // show the Ban User confirmation modal
  function confirmBanUser(reportId, username) {
    document.getElementById("banReportId").value = reportId;
    document.getElementById("banUsername").textContent = username;
    var banModal = new bootstrap.Modal(document.getElementById("banUserModal"));
    banModal.show();
  }

  // Execute ban user action
  function banUser() {
    const reportId = document.getElementById("banReportId").value;
    takeAction(reportId, "ban_user");
    var banModal = bootstrap.Modal.getInstance(
      document.getElementById("banUserModal")
    );
    banModal.hide();
  }

  //
  //
  document
    .getElementById("hideCommentForm")
    .addEventListener("submit", function (event) {
      event.preventDefault();
      const reportId = document.getElementById("hideReportId").value;
      const reason = document.getElementById("moderationReason").value;
      // Pass the commentId to takeAction if your backend needs it for hiding,
      // though the reportId should be enough to find the comment via the report.
      takeAction(reportId, "hide", reason);
      var hideModal = bootstrap.Modal.getInstance(
        document.getElementById("hideCommentModal")
      );
      hideModal.hide();
      this.reset();
    });

  // Main action handling function
  async function takeAction(reportId, actionType, reason = null) {
    const formData = new FormData();
    formData.append("action", actionType);
    if (reason && actionType === "hide") {
      // Only send reason for 'hide' action
      formData.append("moderation_reason", reason);
    }

    try {
      const response = await fetch(`/moderation/comment/action/${reportId}`, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const result = await response.json();
      if (result.success) {
        let message = result.message;
        if (result.affected_reports && result.affected_reports > 1) {
          message += `\n\n(${result.affected_reports} related reports were also updated)`;
        }

        if (confirm(message + "\n\nClick OK to refresh the page.")) {
          window.location.reload();
        } else {
          window.location.reload(); // refresh the page regardless of user choice
        }
      } else {
        alert("Error: " + result.message);
      }
    } catch (error) {
      console.error("Error executing action:", error);
      alert(
        "An error occurred while processing your request. Please try again."
      );
    }
  }
</script>
{% endblock %}
