{% extends 'userbase.html' %}

{% block title %}
{% if is_new_conversation %}
Message {{ conversation_partner_username }}
{% else %}
Conversation with {{ conversation_partner_username }}
{% endif %}
{% endblock %}


{% block content %}
<style>
    .chat-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px 0;
    }

    .chat-message-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 18px;
    }

    .chat-message-row.self {
        flex-direction: row-reverse;
    }

    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 10px;
    }

    .chat-bubble {
        max-width: 320px;
        padding: 10px 16px;
        border-radius: 18px;
        position: relative;
        word-break: break-word;
        font-size: 1rem;
    }

    .chat-bubble.other {
        background: #f1f0f0;
        color: #222;
        border-bottom-left-radius: 4px;
    }

    .chat-bubble.self {
        background: #1b9b5f;
        color: #fff;
        border-bottom-right-radius: 4px;
    }

    .chat-meta {
        font-size: 0.8rem;
        color: #888;
        margin: 2px 0 0 4px;
    }
</style>

<div class="container mt-4">
    <h3>
        Conversation with {{ conversation_partner_username }}
    </h3>

    {% if messages %}
    <div id="chat-messages" class="chat-container mb-3">
        {% for message in messages %}
        <div class="chat-message-row {% if message.is_self %}self{% endif %}">
            {% if message.sender_avatar_url %}
            <img class="chat-avatar" src="{{ message.sender_avatar_url }}" alt="avatar">
            {% else %}
            <img class="chat-avatar" src="{{ url_for('static', filename='avatars/default.png') }}" alt="avatar">
            {% endif %}
            <div>
                <div class="chat-bubble {% if message.is_self %}self{% else %}other{% endif %}">
                    {{ message.content }}
                </div>
                <div class="chat-meta">
                    {{ message.sender_username }} Â· {{ message.created_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div id="chat-messages" class="chat-container mb-3">
        {% if is_new_conversation %}
        <div class="alert alert-info">
            No messages yet. Say hello to {{ conversation_partner_username }}!
        </div>
        {% else %}
        <div class="alert alert-secondary">No messages in this conversation.</div>
        {% endif %}
    </div>
    {% endif %}

    {% if can_send_message %}
    <form id="sendMessageForm">
        <input type="hidden" name="recipient_id" value="{{ other_user_id }}">
        <div class="form-group">
            <textarea name="content" class="form-control" rows="3" placeholder="Type your message..."></textarea>
        </div>
        <button type="submit" class="btn btn-dark mt-2">Send</button>
    </form>
    {% else %}
    <div class="alert alert-warning mt-3">
        You must be a paid subscriber or staff to send private messages.
    </div>
    {% endif %}
</div>
<input type="hidden" id="conversation-id-holder" value="{{ conversation_id or '' }}">

<script>
    // Get initial message count from server-rendered messages
    let lastMessageCount = {{ messages| length if messages else 0 }};

    // Get conversation_id from the hidden input field
    const conversationIdInput = document.getElementById('conversation-id-holder');
    const conversationId = conversationIdInput ? conversationIdInput.value : null;

    // Define URLs - static parts can be generated by Jinja
    // Use a dummy integer for url_for, then replace it in JS to get the base path.
    const DUMMY_ID_PLACEHOLDER = "999999999"; // Use a string for replacement consistency
    const conversationDataUrlBase = "{{ url_for('message.conversation_data', conversation_id=999999999) }}".replace(DUMMY_ID_PLACEHOLDER, ''); // Gets base URL like /message/conversation_data/
    const sendMessageUrl = "{{ url_for('message.send_message') }}";

    function refreshMessages() {
        if (conversationId) {
            // Construct the full URL for fetching conversation data
            const fetchUrl = conversationDataUrlBase + conversationId;
            fetch(fetchUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.messages.length > lastMessageCount) {
                        const chatContainer = document.getElementById('chat-messages');
                        chatContainer.innerHTML = data.html; // Assuming data.html contains the rendered messages
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        lastMessageCount = data.messages.length;
                    }
                })
                .catch(error => console.error('Error refreshing messages:', error));
        } else {
            // If not in a specific conversation (e.g., starting a new one but page hasn't reloaded with an ID yet)
            // or if on a page that should show a list/overview if no specific conversation.
            // For this specific case, if the URL implies a conversation, reload.
            const currentUrl = window.location.pathname;
            if (currentUrl.includes('/message/conversation/')) {

            }
        }
    }

    const sendMessageForm = document.getElementById("sendMessageForm");
    if (sendMessageForm) {
        sendMessageForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            fetch(sendMessageUrl, {
                method: "POST",
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        form.querySelector('textarea[name="content"]').value = ''; // Clear textarea

                        if (conversationId) {
                            refreshMessages(); // Refresh messages if in an existing conversation
                        } else {
                            // If it was a new message to start a conversation,
                            // the backend should ideally redirect to the new conversation URL,
                            // or this reload will show the updated state (e.g. the new conversation in a list).
                            window.location.reload();
                        }
                    } else {
                        alert(data.message || "Failed to send message.");
                    }
                })
                .catch(err => {
                    console.error("Error sending message:", err);
                    alert("An error occurred while sending the message.");
                });
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (conversationId) {
            setInterval(refreshMessages, 3000); // Refresh messages every 3 seconds
        }

        const chatContainer = document.getElementById('chat-messages');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom on load
        }
    });
</script>
{% endblock %}