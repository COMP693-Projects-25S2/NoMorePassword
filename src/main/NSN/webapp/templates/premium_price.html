{% extends 'userbase.html' %}

{% block title %}Premium{% endblock %}

{# Set the active page to be highlighted in the navigation bar. #}
{% set active_page = 'premium' %}


{% block content %}
<div class="banner-image"
    style="background-image: url('/static/ui_photos/private_journey.jpg'); background-size: cover; background-position: center; height: 300px; position: relative;">
    <div class="banner-overlay"
        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-md-12 text-end">
                    <h1 class="text-white fw-bold">Premium</h1>
                    <p class="text-white lead">Get better experiences from now on</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
    rel="stylesheet">

<div class="contianer mt-4">

    <div class="row mb-5">
        {% for subscription in subscriptions %}

        <div class="col-md-4">
            <div class="card selectable-card" data-id="{{subscription.s_id}}">
                <div class="card-header bg-dark text-white  position-relative py-3">
                    <h5 class="mb-0 text-center fw-bold">{{subscription.s_name}}</h5>
                    <span class="position-absolute top-0 end-0 translate-middle badge rounded-pill bg-danger">
                        -{{subscription.discount}}%
                    </span>
                </div>
                <div class="card-body d-flex flex-column text-center p-4">
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-calendar2-check text-dark me-2"></i>
                            <span>Subscription Plan: <strong>{{subscription.period}} days</strong></span>
                        </div>
                    </div>

                    <div class="price-section my-4">
                        <div>
                            <span class="text-decoration-line-through text-muted fs-5">NZ
                                ${{subscription.base_price}}</span>
                        </div>
                        <div class="fs-1 fw-bold text-dark">
                            <span class="fs-6 align-top text-muted me-1">NZ $</span>{{subscription.price}}
                        </div>
                    </div>

                    <p class="text-muted mb-4">{{subscription.s_description}}</p>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>


    <form id="cardForm" method="POST" action="{{ url_for('preview_purchase_premium') }}">
        <input type="hidden" name="subscription_id" id="selectedCardId">
        <div class="d-flex justify-content-center">
            {% if trail is none %}
            <!-- <a href="{{ url_for('trail_premium') }}" class="btn btn-secondary w-25 me-2">Trail</a> -->

            <button type="button" id="openModalBtn" class="btn btn-secondary w-25 me-2">Trail</button>

            <div id="myModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Confirm Free Trail</h2>
                        <button class="close" id="closeModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Confirm your chance to use the free trial for one month?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancelBtn" class="modal-btn btn-default">Cancel</button>
                        <button type="button" id="confirmBtn" class="modal-btn btn-primary">Confirm</button>
                    </div>
                </div>
            </div>

            <script>
                // Get modal dialog and button elements
                const modal = document.getElementById('myModal');
                const openBtn = document.getElementById('openModalBtn');
                const closeBtn = document.getElementById('closeModal');
                const cancelBtn = document.getElementById('cancelBtn');
                const confirmBtn = document.getElementById('confirmBtn');

                // API URL - modify this URL as needed
                const apiUrl = "{{ url_for('trail_premium') }}";

                // Open modal dialog
                openBtn.addEventListener('click', function () {
                    modal.style.display = 'flex';
                });

                // Function to close modal dialog
                function closeModal() {
                    modal.style.display = 'none';
                }

                // Close dialog when clicking close button
                closeBtn.addEventListener('click', closeModal);

                // Close dialog when clicking cancel button
                cancelBtn.addEventListener('click', closeModal);

                // Click confirm button to call API and close dialog
                confirmBtn.addEventListener('click', function () {
                    window.location.href = apiUrl;
                });

                // Close dialog when clicking outside the modal
                window.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        closeModal();
                    }
                });
            </script>

            {% else %}



            <button type="button" class="btn btn-secondary w-25 me-2" onclick="showCustomAlert()">Trail</button>

            <div id="customAlert" class="modal">
                <div class="modal-content">

                    <div class="modal-header">
                        <h2 class="modal-title">Free Trail Not Available</h2>
                        <button class="close" id="closeModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>You have already had a trail <br>from {{trail.start_time}} <br>to {{trail.end_time}}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary w-25 me-2"
                            onclick="closeAndRefresh()">Ok</button>
                    </div>


                    <!-- <div class="d-flex justify-content-start">
                        <p>You have already had a trail from {{trail.start_time}} to {{trail.end_time}}</p>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary w-25 me-2"
                            onclick="closeAndRefresh()">Ok</button>
                    </div> -->
                </div>
            </div>

            <script>
                function showCustomAlert() {
                    document.getElementById("customAlert").style.display = "block";
                }

                function closeAndRefresh() {
                    document.getElementById("customAlert").style.display = "none";
                    location.reload();  // refresh
                }
            </script>
            {% endif %}

            <button type="submit" class="btn btn-dark w-25 me-2">Purchase</button>
            <a href="{{ url_for('premium_history') }}?user_id={{session.user_id}}"
                class="btn btn-success w-25 me-2">History</a>

        </div>
    </form>


</div>

<script>
    let selectedId = null;

    document.querySelectorAll('.selectable-card').forEach(card => {
        card.addEventListener('click', function () {
            // clear
            document.querySelectorAll('.selectable-card').forEach(c => c.classList.remove('selected'));

            // set new selected card
            this.classList.add('selected');
            // set data-id to selectedId
            const selectedId = this.getAttribute('data-id');
            document.getElementById('selectedCardId').value = selectedId;
        });
    });

    document.getElementById('cardForm').addEventListener('submit', function (e) {

        console.log('selectedCardId=', document.getElementById('selectedCardId').value)

        if (!document.getElementById('selectedCardId').value) {
            e.preventDefault();
            alert("Please choose a subscription method first!");
        }
    });
</script>


<style>
    .selectable-card {
        cursor: pointer;
        transition: border 0.2s ease;
    }

    /* h-100 shadow-sm rounded-4 border-0 */
    .selectable-card.selected {
        border: 2px solid #dd00ff;
        box-shadow: 0 0 10px rgba(195, 0, 255, 0.5);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 1000;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        width: 350px;
        margin: 15% auto;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .modal-title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
    }

    .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
        border: none;
        background: none;
    }

    .close:hover {
        color: #555;
    }

    .modal-body {
        margin-bottom: 15px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        border-top: 1px solid #ddd;
        padding-top: 15px;
    }

    .modal-btn {
        padding: 8px 16px;
        margin-left: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary {
        background-color: black;
        color: white;
    }

    .btn-primary:hover {
        background-color: rgb(72, 72, 72);
    }

    .btn-default {
        color: white;
        background-color: gray;

    }

    .btn-default:hover {
        color: white;
        background-color: rgb(183, 182, 182);
    }
</style>

{% endblock %}