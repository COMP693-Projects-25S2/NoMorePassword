{% extends 'userbase.html' %}

{% block title %}Travel Journal{% endblock %}

{# Set the active page to be highlighted in the navigation bar. #}
{% set active_page = 'signup' %}


{% block content %}

<div class="banner-image"
    style="background-image: url('/static/ui_photos/private_journey.jpg'); background-size: cover; background-position: center; height: 300px; position: relative;">
    <div class="banner-overlay"
        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-md-12 text-end">
                    <h1 class="text-white fw-bold">signup</h1>
                    <p class="text-white lead">Register to share your journey.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h3 class="card-title mb-0">Create an Account</h3>
                </div>
                <div class="card-body">
                    {% if signup_successful %}
                    <div class="alert alert-dark">
                        <h4>Registration Successful!</h4>
                        <p>Your account has been created successfully. You can now <a
                                href="{{ url_for('login') }}">login</a> to start your travel journal.</p>
                        {% if new_user_id %}
                        <p><small>User ID: {{ new_user_id }}</small></p>
                        {% endif %}
                    </div>
                    {% else %}
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <form method="post" action="{{ url_for('signup') }}">
                        <!-- NMP parameters for Sign Up with NMP -->
                        {% if nmp_user_id %}
                        <input type="hidden" name="nmp_user_id" value="{{ nmp_user_id }}">
                        <input type="hidden" name="nmp_username" value="{{ nmp_username }}">
                        <input type="hidden" name="nmp_client_type" value="{{ nmp_client_type }}">
                        <input type="hidden" name="nmp_timestamp" value="{{ nmp_timestamp }}">
                        <input type="hidden" name="nmp_ip_address" value="{{ nmp_ip_address }}">
                        <input type="hidden" name="nmp_port" value="{{ nmp_port }}">
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">Username*</label>
                                <input type="text" class="form-control {% if username_error %}is-invalid{% endif %}"
                                    id="username" name="username" value="{{ username if username }}" required>
                                {% if username_error %}
                                <div class="invalid-feedback">{{ username_error }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Address*</label>
                                <input type="email" class="form-control {% if email_error %}is-invalid{% endif %}"
                                    id="email" name="email" value="{{ email if email }}" required>
                                {% if email_error %}
                                <div class="invalid-feedback">{{ email_error }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Password*</label>
                                <input type="password" class="form-control {% if password_error %}is-invalid{% endif %}"
                                    id="password" name="password" required>
                                {% if password_error %}
                                <div class="invalid-feedback">{{ password_error }}</div>
                                {% endif %}
                                <div class="form-text">At least 8 characters, including uppercase, lowercase, number,
                                    and special character.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="confirm_password" class="form-label">Confirm Password*</label>
                                <input type="password"
                                    class="form-control {% if confirm_password_error %}is-invalid{% endif %}"
                                    id="confirm_password" name="confirm_password" required>
                                {% if confirm_password_error %}
                                <div class="invalid-feedback">{{ confirm_password_error }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control {% if first_name_error %}is-invalid{% endif %}"
                                    id="first_name" name="first_name" value="{{ first_name if first_name }}">
                                {% if first_name_error %}
                                <div class="invalid-feedback">{{ first_name_error }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control {% if last_name_error %}is-invalid{% endif %}"
                                    id="last_name" name="last_name" value="{{ last_name if last_name }}">
                                {% if last_name_error %}
                                <div class="invalid-feedback">{{ last_name_error }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-grid">
                            <label for="location" class="form-label">Home Location</label>

                            <input type="text" class="search-input" id="input_location" name="location"
                                placeholder="Please enter an address or landmark..." autocomplete="off"
                                value="{{address}}">
                            <div id="suggestions" class="suggestions"></div>

                            <script>
                                // JS for quick search location
                                document.addEventListener('DOMContentLoaded', function () {
                                    const searchInput = document.getElementById('input_location');
                                    const suggestionsContainer = document.getElementById('suggestions');
                                    let debounceTimer;
                                    let selectedIndex = -1;
                                    let suggestions = [];

                                    searchInput.addEventListener('input', function () {
                                        const query = this.value.trim();

                                        clearTimeout(debounceTimer);

                                        if (query.length < 2) {
                                            suggestionsContainer.style.display = 'none';
                                            return;
                                        }

                                        suggestionsContainer.innerHTML = '<div class="loading">finding...</div>';
                                        suggestionsContainer.style.display = 'block';

                                        debounceTimer = setTimeout(function () {
                                            fetchSuggestions(query);
                                        }, 300);
                                    });

                                    searchInput.addEventListener('keydown', function (e) {
                                        if (!suggestions.length || suggestionsContainer.style.display === 'none') return;

                                        if (e.key === 'ArrowDown') {
                                            e.preventDefault();
                                            selectedIndex = (selectedIndex + 1) % suggestions.length;
                                            updateSelection();
                                        }
                                        else if (e.key === 'ArrowUp') {
                                            e.preventDefault();
                                            selectedIndex = selectedIndex <= 0 ? suggestions.length - 1 : selectedIndex - 1;
                                            updateSelection();
                                        }
                                        else if (e.key === 'Enter' && selectedIndex >= 0) {
                                            e.preventDefault();
                                            selectSuggestion(suggestions[selectedIndex]);
                                        }
                                        else if (e.key === 'Escape') {
                                            suggestionsContainer.style.display = 'none';
                                            selectedIndex = -1;
                                        }
                                    });

                                    document.addEventListener('click', function (e) {
                                        if (!suggestionsContainer.contains(e.target) && e.target !== searchInput) {
                                            suggestionsContainer.style.display = 'none';
                                            selectedIndex = -1;
                                        }
                                    });

                                    function fetchSuggestions(query) {
                                        fetch(`/location/search?keyword=${encodeURIComponent(query)}`)
                                            .then(response => response.json())
                                            .then(data => {
                                                suggestions = data;
                                                renderSuggestions(query, data);
                                            })
                                            .catch(error => {
                                                console.error('search failed:', error);
                                                suggestionsContainer.innerHTML = '<div class="no-results">no results, please retry...</div>';
                                            });
                                    }

                                    function renderSuggestions(query, suggestions) {
                                        suggestionsContainer.innerHTML = '';

                                        if (suggestions.length === 0) {
                                            suggestionsContainer.innerHTML = '<div class="no-results">no matched address</div>';
                                            return;
                                        }

                                        suggestions.forEach((suggestion, index) => {
                                            const item = document.createElement('div');
                                            item.className = 'suggestion-item';
                                            if (index === selectedIndex) {
                                                item.classList.add('selected');
                                            }

                                            const highlightedText = highlightMatch(suggestion, query);
                                            item.innerHTML = highlightedText;

                                            item.addEventListener('click', function () {
                                                selectSuggestion(suggestion);
                                            });

                                            item.addEventListener('mouseover', function () {
                                                selectedIndex = index;
                                                updateSelection();
                                            });

                                            suggestionsContainer.appendChild(item);
                                        });

                                        suggestionsContainer.style.display = 'block';
                                    }

                                    function highlightMatch(text, query) {
                                        const regex = new RegExp(escapeRegExp(query), 'gi');
                                        return text.replace(regex, match => `<span class="highlight">${match}</span>`);
                                    }

                                    function escapeRegExp(string) {
                                        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                    }

                                    function updateSelection() {
                                        const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                                        items.forEach((item, index) => {
                                            if (index === selectedIndex) {
                                                item.classList.add('selected');
                                                item.scrollIntoView({ block: 'nearest' });
                                            } else {
                                                item.classList.remove('selected');
                                            }
                                        });
                                    }

                                    function selectSuggestion(suggestion) {
                                        searchInput.value = suggestion;
                                        suggestionsContainer.style.display = 'none';
                                        selectedIndex = -1;
                                        searchInput.focus();
                                    }
                                });
                            </script>

                        </div>

                        <div class="row">
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-dark">Register</button>
                            </div>
                        </div>
                    </form>
                    {% endif %}
                </div>
                <div class="card-footer text-center">
                    <p class="mb-0">Already have an account? <a href="{{ url_for('login') }}">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="invisible">signup_successful: {{signup_successful}}</div>
<div class="invisible">username_error: {{username_error}}</div>
<div class="invisible">email_error: {{email_error}}</div>
<div class="invisible">password_error: {{password_error}}</div>
<div class="invisible">confirm_password_error: {{confirm_password_error}}</div>
<div class="invisible">first_name_error: {{first_name_error}}</div>
<div class="invisible">last_name_error: {{last_name_error}}</div>

{% endblock %}