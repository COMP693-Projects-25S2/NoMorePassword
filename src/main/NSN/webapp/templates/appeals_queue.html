{% extends 'userbase.html' %}

{% block title %}Appeals Queue{% endblock %}

{% set active_page = 'appeals' %}

{% block head_extras %}
<style>
    .appeal-card {
        transition: all 0.3s ease;
    }

    .appeal-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .status-pending { border-left: 4px solid #ffc107; }
    .status-approved { border-left: 4px solid #198754; }
    .status-rejected { border-left: 4px solid #dc3545; }

    .appeal-content {
        max-height: 100px;
        overflow-y: auto;
        font-size: 0.9rem;
    }

    .review-form {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .quick-responses {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .quick-response-btn {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }

    .filter-badge {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Banner -->
<div class="banner-image"
    style="background-image: url('/static/ui_photos/private_journey.jpg'); background-size: cover; background-position: center; height: 300px; position: relative;">
    <div class="banner-overlay"
        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-md-12 text-end">
                    <h1 class="text-white fw-bold">Appeals Queue</h1>
                    <p class="text-white lead">Review and manage user appeals</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>Filter Appeals
                    </h5>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end gap-2">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Status: {{ current_status|title or 'All' }}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', type=request.args.get('type', '')) }}">All Statuses</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status='pending', type=request.args.get('type', '')) }}">Pending</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status='approved', type=request.args.get('type', '')) }}">Approved</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status='rejected', type=request.args.get('type', '')) }}">Rejected</a></li>
                            </ul>
                        </div>

                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Type: {{ current_type|replace('_', ' ')|title or 'All' }}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status=request.args.get('status', '')) }}">All Types</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status=request.args.get('status', ''), type='hidden_journey') }}">Hidden Journey</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status=request.args.get('status', ''), type='sharing_block') }}">Sharing Block</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('appeals_queue', status=request.args.get('status', ''), type='site_ban') }}">Site Ban</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div class="mt-3">
                {% if current_status %}
                <span class="badge bg-primary filter-badge">Status: {{ current_status|title }}</span>
                {% endif %}
                {% if current_type %}
                <span class="badge bg-secondary filter-badge">Type: {{ current_type|replace('_', ' ')|title }}</span>
                {% endif %}
                {% if current_status or current_type %}
                <a href="{{ url_for('appeals_queue') }}" class="btn btn-sm btn-outline-dark">Clear Filters</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Appeals List -->
    {% if appeals %}
    <div class="row">
        {% for appeal in appeals %}
        <div class="col-12 mb-4">
            <div class="card appeal-card status-{{ appeal.status }}">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-0">
                                {% if appeal.appeal_type == 'hidden_journey' %}
                                    <i class="fas fa-eye-slash text-warning me-2"></i>Hidden Journey Appeal
                                {% elif appeal.appeal_type == 'sharing_block' %}
                                    <i class="fas fa-ban text-danger me-2"></i>Sharing Block Appeal
                                {% elif appeal.appeal_type == 'site_ban' %}
                                    <i class="fas fa-user-slash text-danger me-2"></i>Site Ban Appeal
                                {% endif %}

                                {% if appeal.journey_title %}
                                    - "{{ appeal.journey_title }}"
                                {% endif %}
                            </h6>
                            <small class="text-muted">
                                By {{ appeal.username }} ({{ appeal.email }}) â€¢
                                {{ appeal.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-{{ 'warning' if appeal.status == 'pending' else 'success' if appeal.status == 'approved' else 'danger' }} fs-6">
                                {{ appeal.status|title }}
                            </span>
                            {% if appeal.status == 'pending' %}
                            <button class="btn btn-sm btn-primary ms-2 review-btn" data-appeal-id="{{ appeal.appeal_id }}">
                                <i class="fas fa-gavel me-1"></i>Review
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h6>User's Justification:</h6>
                            <div class="appeal-content">{{ appeal.justification }}</div>

                            {% if appeal.status != 'pending' %}
                            <hr>
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-muted">Admin Response:</h6>
                                    <p class="mb-0">{{ appeal.admin_response or 'No response provided.' }}</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-muted">
                                        Reviewed by {{ appeal.reviewer_username or 'Unknown' }}<br>
                                        {{ appeal.reviewed_at.strftime('%b %d, %Y at %I:%M %p') if appeal.reviewed_at else 'Unknown date' }}
                                    </small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Review Form (hidden by default) -->
                    {% if appeal.status == 'pending' %}
                    <div class="review-form" id="reviewForm-{{ appeal.appeal_id }}">
                        <form class="review-appeal-form" data-appeal-id="{{ appeal.appeal_id }}">
                            <div class="mb-3">
                                <label class="form-label">Decision:</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="decision" id="approve-{{ appeal.appeal_id }}" value="approved" required>
                                        <label class="form-check-label text-success" for="approve-{{ appeal.appeal_id }}">
                                            <i class="fas fa-check me-1"></i>Approve
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="decision" id="reject-{{ appeal.appeal_id }}" value="rejected" required>
                                        <label class="form-check-label text-danger" for="reject-{{ appeal.appeal_id }}">
                                            <i class="fas fa-times me-1"></i>Reject
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="response-{{ appeal.appeal_id }}" class="form-label">Response to User *</label>
                                <div class="quick-responses">
                                    <button type="button" class="btn btn-sm btn-outline-secondary quick-response-btn"
                                            data-response="Your appeal has been approved. The restriction has been removed.">
                                        Quick: Approved
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary quick-response-btn"
                                            data-response="Your appeal has been rejected as the restriction was applied correctly according to our community guidelines.">
                                        Quick: Policy Violation
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary quick-response-btn"
                                            data-response="Your appeal has been rejected due to insufficient justification. Please provide more details if you wish to re-appeal.">
                                        Quick: Insufficient Info
                                    </button>
                                </div>
                                <textarea class="form-control" id="response-{{ appeal.appeal_id }}" name="admin_response"
                                          rows="4" required minlength="10"
                                          placeholder="Provide a clear explanation of your decision for the user..."></textarea>
                                <div class="form-text">Minimum 10 characters. This will be visible to the user.</div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary cancel-review-btn">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-gavel me-1"></i>Submit Decision
                                </button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- No Appeals -->
    <div class="text-center py-5">
        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
        <h4>No Appeals Found</h4>
        <p class="text-muted">
            {% if current_status == 'pending' %}
                There are currently no pending appeals to review.
            {% elif current_status %}
                No appeals found with status "{{ current_status }}".
            {% else %}
                No appeals have been submitted yet.
            {% endif %}
        </p>
        {% if current_status or current_type %}
        <a href="{{ url_for('appeals_queue') }}" class="btn btn-primary">View All Appeals</a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewBtns = document.querySelectorAll('.review-btn');
    const cancelBtns = document.querySelectorAll('.cancel-review-btn');
    const quickResponseBtns = document.querySelectorAll('.quick-response-btn');
    const reviewForms = document.querySelectorAll('.review-appeal-form');

    // Show review form
    reviewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const appealId = this.dataset.appealId;
            const form = document.getElementById(`reviewForm-${appealId}`);
            form.style.display = 'block';
            this.style.display = 'none';
        });
    });

    // Cancel review
    cancelBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const form = this.closest('.review-form');
            const appealId = form.id.split('-')[1];
            const reviewBtn = document.querySelector(`[data-appeal-id="${appealId}"]`);

            form.style.display = 'none';
            reviewBtn.style.display = 'inline-block';
            form.querySelector('form').reset();
        });
    });

    // Quick response buttons
    quickResponseBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const response = this.dataset.response;
            const textarea = this.closest('.review-form').querySelector('textarea[name="admin_response"]');
            textarea.value = response;
        });
    });

    // Form submission
    reviewForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const appealId = this.dataset.appealId;
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';

            fetch(`/appeals/${appealId}/review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        Appeal ${data.decision} successfully! The user will be notified.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    const container = document.querySelector('.container');
                    container.insertBefore(alert, container.firstChild);

                    // Reload page after delay
                    setTimeout(() => {
                        location.reload();
                    }, 2000);

                } else {
                    throw new Error(data.error || 'An error occurred');
                }
            })
            .catch(error => {
                // Show error message
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${error.message || 'An error occurred while processing the appeal.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                this.prepend(alert);
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    });
});
</script>
{% endblock %}